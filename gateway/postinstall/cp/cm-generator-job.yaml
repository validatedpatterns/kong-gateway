apiVersion: batch/v1
kind: Job
metadata:
  namespace: kong
  name: cm-generator
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: kong
      volumes:
      - name: cm-generator
        configMap:
          name: cm-generator
          defaultMode: 0711 
      containers:
      - image: cmwylie19/kube-argo-base
        name: cm-generator
        resources: {}
        volumeMounts:
        - name: cm-generator
          mountPath: /opt/scripts
        securityContext:
           runAsUser: 0
        command: ["sh","-c","/opt/scripts/cm-creator.sh"]
---
apiVersion: v1
data:
  cm-creator.sh: |-
    #!/bin/bash
    set -eu

    # allow LB to establish IP
    sleep 30

    CLUSTER_URL=$(oc get svc kong-kong-cluster -ojsonpath='{.status.loadBalancer.ingress[].ip}' -n kong)

    # while CLUSTER_URL is null
    while [ -z "$CLUSTER_URL"]
    do
        # gcp
        CLUSTER_URL=$(oc get svc kong-kong-cluster -ojsonpath='{.status.loadBalancer.ingress[].ip}' -n kong)

        if [ -z "$CLUSTER_URL" ];
        then 
            # aws
            CLUSTER_URL=$(oc get svc kong-kong-cluster -ojsonpath='{.status.loadBalancer.ingress[].hostname}' -n kong)
        else 
            echo "CLUSTER_URL Not NULL";
        fi
    done


    CLUSTER_TELEMETRY_URL=$(oc get svc kong-kong-clustertelemetry -n kong -ojsonpath='{.status.loadBalancer.ingress[].ip}' -n kong)

    # while CLUSTER_TELEMETRY_URL is null
    while [ -z "$CLUSTER_TELEMETRY_URL"]
    do
        # gcp
        CLUSTER_TELEMETRY_URL=$(oc get svc kong-kong-clustertelemetry -n kong -ojsonpath='{.status.loadBalancer.ingress[].ip}' -n kong)

        if [ -z "$CLUSTER_TELEMETRY_URL" ];
        then 
            # aws
            CLUSTER_TELEMETRY_URL=$(oc get svc kong-kong-clustertelemetry -n kong -ojsonpath='{.status.loadBalancer.ingress[].hostname}' -n kong)
        else 
            echo "CLUSTER_TELEMETRY_URL Not NULL";
        fi
    done

    echo "ClUSTER_URL $CLUSTER_URL"

    echo "CLUSTER_TELEMETRY_URL $CLUSTER_TELEMETRY_URL"

    kubectl create cm cluster-urls -n kong --from-literal=CLUSTER_URL=$CLUSTER_URL --from-literal=CLUSTER_TELEMETRY_URL=$CLUSTER_TELEMETRY_URL
kind: ConfigMap
metadata:
  name: cm-generator
  namespace: kong
  annotations:
    argocd.argoproj.io/sync-wave: "3"